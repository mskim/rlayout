
FONT_WIDTH_TABLE =  {"Times"=>{:acender=>750.0, :descender=>-250.0, :leading=>0.0, :ascii_width=>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 28.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 250.0, 333.0078125, 408.203125, 500.0, 500.0, 833.0078125, 777.83203125, 180.17578125, 333.0078125, 333.0078125, 500.0, 563.96484375, 250.0, 333.0078125, 250.0, 277.83203125, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 277.83203125, 277.83203125, 563.96484375, 563.96484375, 563.96484375, 443.84765625, 920.8984375, 722.16796875, 666.9921875, 666.9921875, 722.16796875, 610.83984375, 556.15234375, 722.16796875, 722.16796875, 333.0078125, 389.16015625, 722.16796875, 610.83984375, 889.16015625, 722.16796875, 722.16796875, 556.15234375, 722.16796875, 666.9921875, 556.15234375, 610.83984375, 722.16796875, 722.16796875, 943.84765625, 722.16796875, 722.16796875, 610.83984375, 333.0078125, 277.83203125, 333.0078125, 469.23828125, 500.0, 333.0078125, 443.84765625, 500.0, 443.84765625, 500.0, 443.84765625, 333.0078125, 500.0, 500.0, 277.83203125, 277.83203125, 500.0, 277.83203125, 777.83203125, 500.0, 500.0, 500.0, 500.0, 333.0078125, 389.16015625, 277.83203125, 500.0, 500.0, 722.16796875, 500.0, 500.0, 443.84765625, 479.98046875, 200.1953125, 479.98046875, 541.015625, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 250.0, 333.0078125, 500.0, 500.0, 500.0, 500.0, 200.1953125, 500.0, 333.0078125, 759.765625, 275.87890625, 500.0, 563.96484375, 0.0, 759.765625, 333.0078125, 399.90234375, 548.828125, 299.8046875, 299.8046875, 333.0078125, 576.171875, 453.125, 250.0, 333.0078125, 299.8046875, 310.05859375, 500.0, 750.0, 750.0, 750.0, 443.84765625, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 889.16015625, 666.9921875, 610.83984375, 610.83984375, 610.83984375, 610.83984375, 333.0078125, 333.0078125, 333.0078125, 333.0078125, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 563.96484375, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 722.16796875, 556.15234375, 500.0, 443.84765625, 443.84765625, 443.84765625, 443.84765625, 443.84765625, 443.84765625, 666.9921875, 443.84765625, 443.84765625, 443.84765625, 443.84765625, 443.84765625, 277.83203125, 277.83203125, 277.83203125, 277.83203125, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 548.828125, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0]}, "Helvetica"=>{:acender=>778.001576662064, :descender=>-221.000447869301, :leading=>0.0, :ascii_width=>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 28.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 278.0, 278.0, 355.0, 556.0, 556.0, 889.0, 667.0, 191.0, 333.0, 333.0, 389.0, 584.0, 278.0, 333.0, 278.0, 278.0, 556.0, 556.0, 556.0, 556.0, 556.0, 556.0, 556.0, 556.0, 556.0, 556.0, 278.0, 278.0, 584.0, 584.0, 584.0, 556.0, 1015.0, 667.0, 667.0, 722.0, 722.0, 667.0, 611.0, 778.0, 722.0, 278.0, 500.0, 667.0, 556.0, 833.0, 722.0, 778.0, 667.0, 778.0, 722.0, 667.0, 611.0, 722.0, 667.0, 944.0, 667.0, 667.0, 611.0, 278.0, 278.0, 278.0, 469.0, 556.0, 333.0, 556.0, 556.0, 500.0, 556.0, 556.0, 278.0, 556.0, 556.0, 222.0, 222.0, 500.0, 222.0, 833.0, 556.0, 556.0, 556.0, 556.0, 333.0, 500.0, 278.0, 556.0, 500.0, 722.0, 500.0, 500.0, 500.0, 334.0, 260.0, 334.0, 584.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 278.0, 333.0, 556.0, 556.0, 632.8125, 556.0, 373.53515625, 556.0, 333.0, 737.0, 370.0, 556.0, 584.0, 0.0, 737.0, 333.0, 400.0, 584.0, 421.875, 421.875, 333.0, 556.0, 537.0, 278.0, 333.0, 421.875, 365.0, 556.0, 801.26953125, 801.26953125, 801.26953125, 611.0, 667.0, 667.0, 667.0, 667.0, 667.0, 667.0, 1000.0, 722.0, 667.0, 667.0, 667.0, 667.0, 278.0, 278.0, 278.0, 278.0, 749.0234375, 722.0, 778.0, 778.0, 778.0, 778.0, 778.0, 794.921875, 778.0, 722.0, 722.0, 722.0, 722.0, 623.046875, 552.734375, 611.0, 556.0, 556.0, 556.0, 556.0, 556.0, 556.0, 889.0, 500.0, 556.0, 556.0, 556.0, 556.0, 278.0, 278.0, 278.0, 278.0, 602.5390625, 556.0, 556.0, 556.0, 556.0, 556.0, 556.0, 584.0, 611.0, 556.0, 556.0, 556.0, 556.0, 522.4609375, 629.39453125, 500.0]}}

class String
  def width_with_font(width_table,font_size,options={})
    char_width_sum = 0
    (self.length).times do |i|
      # if the char is a unicode make the width same as font_size
      if self[i].ord <= 256
        char_width_sum += width_table[self[i].ord]*font_size/1000.0 if width_table[self[i].ord]
      elsif options[:korean_fixed_width]
        char_width_sum += options[:korean_fixed_width]
      else
        char_width_sum += font_size*0.8
      end
    end
    char_width_sum
  end
end

module RLayout

  class RFont
    attr_accessor :font_name, :size, :width_table, :font_info, :korean_fixed_width
    def initialize(font_name, size, options={})
      @font_name    = font_name
      @size         = size
      font_file = "/Users/Shared/SoftwareLab/font_width/#{font_name}.rb"
      if File.exist?(font_file)
        info_rb             = File.open(font_file, 'r'){|f| f.read}
        @font_info          = eval(info_rb)
        @width_table        = @font_info[:ascii_width]
        @korean_fixed_width = @font_info[:korean_fixed_width]
      else
        unless FONT_WIDTH_TABLE.keys.include?(font_name)
          @font_info  = FONT_WIDTH_TABLE["Times"]
          @width_table= @font_info[:ascii_width]
        else
          @font_info  = FONT_WIDTH_TABLE[font_name]
          @width_table= font_info[:ascii_width]
        end
      end
      self
    end

    def string_size(text_string)
      w = text_string.width_with_font(@width_table,@size, korean_fixed_width: @korean_fixed_width)
      h = @size
      [w,h]
    end

    def space_char_width
      @width_table[" ".ord]*@size/1000
    end

    def self.string_size(string, font_name, size)
      RFont.new(font_name, size).string_size(string)
    end
  end

end

__END__


# font_utile

## 1. list all installed fonts

## 2. create font table with given font name in Shared
	font_width_table
		font_name.yml
		Times.yml
		Helvetica.yml

puts RLayout::RFont.string_size("Times", 16, "One")

f= RLayout::RFont.new("Times",16)
puts f.string_size("This is a string")
# puts "This is a string".width_with_font(width_table_with[:ascii_width],16)
# puts rfont = RLayout::RFont.new("Times",16)
# puts rfont.string_size("This is string")
# puts rfont.string_size("This is string which has more text")
#
# puts rfont = RLayout::RFont.new("Times",12)
# puts rfont.string_size("This is string")
# puts rfont.string_size("This is string which has more text")
#
# puts RLayout::RFont.string_size("Times",16, "This is string")


framework 'cocoa'

if RUBY_ENGINE == "macruby"
  framework 'cocoa'
  fonts = NSFontManager.sharedFontManager.availableFontFamilies
  puts fonts.include?("AppleGothic")
  puts fonts.containsObject("AppleGothic")
  # puts "fonts:#{fonts}"
  puts fonts.include?("Times")
  puts fonts.include?("Helvetica")

end

def get_font_info(font_name)
  font_object = NSFont.fontWithName(font_name, size:1000)
  unless font_object
    puts "#{font_name} not found!"
    return Hash.new
  end

  ascii_width = []
  (0..255).each do |i|
    # puts i.chr
    atts={}
    atts[NSFontAttributeName] = font_object #NSFont.fontWithName(font, size:1000)
    att_string=NSMutableAttributedString.alloc.initWithString(string, attributes:atts)
    #TODO att_string.nil?
    ascii_width << att_string.size.width.round(2)
  end
  info = {}
  info[:acender]    = font_object.ascender
  info[:descender]   = font_object.descender
  info[:leading]     = font_object.leading
  info[:ascii_width] = ascii_width
  info
end

font_names = %w[Times Helvetica]
font_lookup_table = {}
font_names.each do |font_name|
  font_lookup_table[font_name] = get_font_info(font_name)
end
puts font_lookup_table
